from django.core.mail import EmailMessagefrom xhtml2pdf import pisa # import python modulefrom django.template.loader import get_templatefrom django.http import HttpResponse, JsonResponsefrom rest_framework.decorators import api_viewfrom django.core.exceptions import ObjectDoesNotExistfrom django.http import Http404from datetime import datetimefrom django.db import connectionimport cx_Oraclefrom io import BytesIO, StringIOimport stringimport datetimefrom django.core.exceptions import ValidationError@api_view(['POST'])def apex_soa_view_demo(request):    data = request.data    date = datetime.now().strftime("%d-%m-%Y_%I-%M-%S_%p")    f =open(f'files/ApexSoaItems_{date}',"w")    f.write(str(data))    f.close()    return JsonResponse({'Message': ' File Created Successfully'})@api_view(['POST'])def apex_soa_view(request):    data = request.data    SID = data['SID']    TEMPLATE_NAME = data['TEMPLATE_NAME'] or None    ID = data['ID'] or None    ITEM_CODE = data['ITEM_CODE'] or None    UOM_CODE = data['UOM_CODE'] or None    INV_CATG =data['INV_CATG'] or None    MIS_CATG =data['MIS_CATG'] or None    ITEM_TEMPLATE =data['ITEM_TEMPLATE'] or None    ASSIGNED_TO =data['ASSIGNED_TO'] or None    STATUS_MSG = data['STATUS_MSG'] or None    LAST_UPDATE_DATE =data['LAST_UPDATE_DATE'] or None    LAST_UPDATED_BY = data['LAST_UPDATED_BY'] or None    DESCRIPTION = data['DESCRIPTION'] or None    LONG_DESCRIPTION =data['LONG_DESCRIPTION'] or None    ITEM_TYPE = data['ITEM_TYPE'] or None    PPC_CATG =data['PPC_CATG'] or None    DRAWING_NUMBER =data['DRAWING_NUMBER'] or None    EXCISE_ITEM_CLASS =data['EXCISE_ITEM_CLASS'] or None    REPORTING_NAME_TYPE = data['REPORTING_NAME_TYPE'] or None    REPORTING_CODE = data['REPORTING_CODE'] or None    MIN_QTY =data['MIN_QTY'] or None    MAX_QTY =data['MAX_QTY'] or None    PROCESS =data['PROCESS'] or None    CUMULATIVE_MANU =data['CUMULATIVE_MANU'] or None    PLANNER =data['PLANNER'] or None    PLANT_TYPE =data['PLANT_TYPE'] or None    PLANNING_REF =data['PLANNING_REF'] or None    MIN_ORDER_QTY =data['MIN_ORDER_QTY'] or None    MAX_ORDER_QTY =data['MAX_ORDER_QTY'] or None    LEAD_LOT_SIZE = data['LEAD_LOT_SIZE'] or None    PROCESSING_LEAD_TIME = data['PROCESSING_LEAD_TIME'] or None    FULL_LEAD_TIME = data['FULL_LEAD_TIME'] or None    SAFETY_STOCK =data['SAFETY_STOCK'] or None    FORECAST_FREQUENCY = data['FORECAST_FREQUENCY'] or None    LIST_PRICE = data['LIST_PRICE'] or None    TAX_PER = data['TAX_PER'] or None    INVOICE_UOM = data['INVOICE_UOM'] or None    EXP_ACCOUNT = data['EXP_ACCOUNT'] or None    MAKE =data['MAKE'] or None    ITEM_CLASS_CODE = data['ITEM_CLASS_CODE'] or None    ITEM_CLASS = data['ITEM_CLASS'] or None    TECH_PARA1 = data['TECH_PARA1'] or None    TECH_PARA2 = data['TECH_PARA2'] or None    TECH_PARA3 = data['TECH_PARA3'] or None    TECH_PARA4 = data['TECH_PARA4'] or None    PANEL_CATEGORY = data['PANEL_CATEGORY'] or None    ORIGNAL_ITEM = data['ORIGNAL_ITEM'] or None    trx_level = data['trx_level'] or None    Forwarded_to = data['Forwarded_to'] or None    Forwarded_by = data['Forwarded_by'] or None    EMAIL = data['EMAIL'] or None    PARENT_ITEM = data['PARENT_ITEM'] or None    INITIATOR_EMAIL= data['INITIATOR_EMAIL'] or None    if SID == 'PROD':        # url_create = f'http://127.0.0.1:8000/{trx_level}/{Forwarded_by}/{Forwarded_to}/{ITEM_TEMPLATE}/{ID}/y'        create_yes = f'''mailto:harshitaagarwal219@gmail.com?subject=Approve%20Apex%20Item%20ID%20({ID})&body=Approval_Data_template"TRX%20Level":"{trx_level}",%0A"Forwarded%20By":"{Forwarded_by}",%0A"Forwarded%20To":"{Forwarded_to}",%0A"Item%20Template":"{ITEM_TEMPLATE}"%0AEnd.%0AThis%20is%20an%20automatically%20generated%20email.%20PLEASE%20DO%20NOT%20MODIFY%20ITS%20CONTENT%20OR%20STRUCTURE!    '''        url_create_yes = create_yes.translate({ord(c): '%20' for c in string.whitespace})        create_no = f'''mailto:harshitaagarwal219@gmail.com?subject=Reject%20Apex%20Item%20ID%20({ID})&body=Reject_Data_template"TRX%20Level":"{trx_level}",%0A"Forwarded%20By":"{Forwarded_by}",%0A"Forwarded%20To":"{Forwarded_to}",%0A"Item%20Template":"{ITEM_TEMPLATE}"%0AEnd.%0AThis%20is%20an%20automatically%20generated%20email.%20PLEASE%20DO%20NOT%20MODIFY%20ITS%20CONTENT%20OR%20STRUCTURE!    '''        url_create_no = create_no.translate({ord(c): '%20' for c in string.whitespace})        ctx = {            'TEMPLATE_NAME': TEMPLATE_NAME,            'ID': ID,            'ITEM_CODE': ITEM_CODE,            'DESCRIPTION': DESCRIPTION,            'UOM_CODE': UOM_CODE,            'INV_CATG': INV_CATG,            'MIS_CATG': MIS_CATG,            'PPC_CATG': PPC_CATG,            'ITEM_TEMPLATE': ITEM_TEMPLATE,            'STATUS_MSG': STATUS_MSG,            'LAST_UPDATE_DATE': LAST_UPDATE_DATE,            'LAST_UPDATED_BY': LAST_UPDATED_BY,            'ASSIGNED_TO': ASSIGNED_TO,            'url_create_yes':url_create_yes,            'url_create_no':url_create_no,        }        # Define your data        sourceHtml = f'''      <!DOCTYPE html>        <html>          <head>            <title>ITEM DETAIL REPORT</title>              </head>          <body>             <nav class="navbar" style="overflow: hidden;background-color: #333;height:16%">               <img src="https://www.modernelectricals.net/img/970x647/c&s.png" alt=""   height=90 width=90 style="display: block;">                                    </nav>             <h1 align="center"> <strong>ITEM DETAIL REPORT</strong></h1>                    <table style="width:100%;border-collapse: collapse;">                      <tr>                        <th style="padding:5px;text-align: left;">ITEM CODE:</th>                        <td style="padding: 5px;text-align: left;">{ITEM_CODE}</td>                          <th style="padding:5px;text-align: left;">UOM CODE:</th>                        <td style="padding: 5px;text-align: left;">{UOM_CODE}</td>                          </tr>                      <tr>                        <th style="padding: 5px;text-align: left;">DESCRIPTION:</td>                        <td style="padding: 5px;text-align: left;">{DESCRIPTION}</td>                         <th style="padding: 5px;text-align: left;">ITEM TEMPLATE:</td>                        <td style="padding: 5px;text-align: left;">{ITEM_TEMPLATE}</td>                      </tr>                         <tr>                        <th style="padding: 5px;text-align: left;">LONG DESCRIPTION:</td>                        <td style="padding: 5px;text-align: left;">{LONG_DESCRIPTION}</td>                      </tr>                    </table>          <br/>             <font color="blue" align="left" size="5"> <strong>ITEM CLASSIFICATION</strong></font>          <hr style="  display: block;border-width: 2px;">          <br/>                          <table style="width:100%;border-collapse: collapse;">                      <tr>                        <th style="padding:5px;text-align: left;">Item Type:</th>                        <td style="padding: 5px;text-align: left;">{ITEM_TYPE}</td>                          <th style="padding:5px;text-align: left;">Item Classification:</th>                        <td style="padding: 5px;text-align: left;">{EXCISE_ITEM_CLASS}</td>                          </tr>                      <tr>                        <th style="padding: 5px;text-align: left;">MIS Category:</td>                        <td style="padding: 5px;text-align: left;">{MIS_CATG}</td>                         <th style="padding: 5px;text-align: left;">Reporting Type:</td>                        <td style="padding: 5px;text-align: left;">{REPORTING_NAME_TYPE}</td>                      </tr>                         <tr>                        <th style="padding: 5px;text-align: left;">INV Category:</td>                        <td style="padding: 5px;text-align: left;">{INV_CATG}</td>                         <th style="padding: 5px;text-align: left;">Reporting Type Code:</td>                        <td style="padding: 5px;text-align: left;">{REPORTING_CODE}</td>                      </tr>                    <tr>                        <th style="padding: 5px;text-align: left;">PPC Category: </td>                        <td style="padding: 5px;text-align: left;">{PPC_CATG}</td>                      </tr>                      <tr>                        <th style="padding: 5px;text-align: left;">Drawing Number: </td>                        <td style="padding: 5px;text-align: left;">{DRAWING_NUMBER}</td>                      </tr>                    </table>            <br/>             <font color="blue" align="left" size="5"> <strong>ITEM PLANNING</strong></font>          <hr style="  display: block;border-width:1px;">          <br/>                          <table style="width:100%;border-collapse: collapse;">                      <tr>                        <th style="padding:5px;text-align: left;">Minimum Quantity:</th>                        <td style="padding: 5px;text-align: left;">{MIN_QTY}</td>                          <th style="padding:5px;text-align: left;">Min. Order Quantity:</th>                        <td style="padding: 5px;text-align: left;">{MIN_ORDER_QTY}</td>                          </tr>                      <tr>                        <th style="padding: 5px;text-align: left;">Maximum Quantity:</td>                        <td style="padding: 5px;text-align: left;">{MAX_QTY}</td>                         <th style="padding: 5px;text-align: left;">Max Order Quantity:</td>                        <td style="padding: 5px;text-align: left;">{MAX_ORDER_QTY}</td>                      </tr>                         <tr>                        <th style="padding: 5px;text-align: left;">Processing:</td>                        <td style="padding: 5px;text-align: left;">{PROCESS}</td>                         <th style="padding: 5px;text-align: left;">Lead Lot Size: </td>                        <td style="padding: 5px;text-align: left;">{LEAD_LOT_SIZE}</td>                      </tr>                    <tr>                        <th style="padding: 5px;text-align: left;">Cumulative Manufacturing:</td>                        <td style="padding: 5px;text-align: left;">{CUMULATIVE_MANU}</td>                       <th style="padding: 5px;text-align: left;">Processing Lead Time:</td>                        <td style="padding: 5px;text-align: left;">{PROCESSING_LEAD_TIME}</td>                      </tr>                         <tr>                        <th style="padding:5px;text-align: left;">Planner:</th>                        <td style="padding: 5px;text-align: left;">{PLANNER}</td>                          <th style="padding:5px;text-align: left;">Full Lead Time:</th>                        <td style="padding: 5px;text-align: left;">{FULL_LEAD_TIME}</td>                          </tr>                      <tr>                        <th style="padding:5px;text-align: left;">Plan Type:</th>                        <td style="padding: 5px;text-align: left;">{PLANT_TYPE}</td>                          <th style="padding:5px;text-align: left;">Safety Stock:</th>                        <td style="padding: 5px;text-align: left;">{SAFETY_STOCK}</td>                      </tr>                     <tr>                        <th style="padding:5px;text-align: left;">Planning Reference:</th>                        <td style="padding: 5px;text-align: left;">{PLANNING_REF}</td>                          <th style="padding:5px;text-align: left;">Forecast Quantity:</th>                        <td style="padding: 5px;text-align: left;">{FORECAST_FREQUENCY}</td>                      </tr>                    </table>             <br/>             <br/>             <br/>             <br/>         <br/>             <br/>             <font color="blue" align="left" size="5"> <strong>ACCOUNTING</strong></font>          <hr style="  display: block;border-width: 2px;">          <br/>                          <table style="width:100%;border-collapse: collapse;">                      <tr>                        <th style="padding:5px;text-align: left;">List Price:</th>                        <td style="padding: 5px;text-align: left;">{LIST_PRICE}</td>                          <th style="padding:5px;text-align: left;">Expense Account: </th>                        <td style="padding: 5px;text-align: left;">{EXP_ACCOUNT}</td>                          </tr>                      <tr>                        <th style="padding: 5px;text-align: left;">Tax Percentage:</td>                        <td style="padding: 5px;text-align: left;">{TAX_PER}</td>                         <th style="padding: 5px;text-align: left;">Expense Account: </td>                        <td style="padding: 5px;text-align: left;">{EXP_ACCOUNT}</td>                      </tr>                      <tr>                        <th style="padding: 5px;text-align: left;">Invoice UOM: </td>                        <td style="padding: 5px;text-align: left;">{INVOICE_UOM}</td>                      </tr>                    </table>            <br/>                 <font color="blue" align="left" size="5"> <strong>ITEM SPECIFICATIONS</strong></font>          <hr style="  display: block;border-width:1px;">          <br/>                          <table style="width:100%;border-collapse: collapse;">                      <tr>                        <th style="padding:5px;text-align: left;">Make: </th>                        <td style="padding: 5px;text-align: left;">{MAKE}</td>                          <th style="padding:5px;text-align: left;">Panel Category:</th>                        <td style="padding: 5px;text-align: left;">{PANEL_CATEGORY}</td>                          </tr>                      <tr>                        <th style="padding: 5px;text-align: left;">Item Class Code:</td>                        <td style="padding: 5px;text-align: left;">{ITEM_CLASS_CODE}</td>                         <th style="padding: 5px;text-align: left;">Original Item:</td>                        <td style="padding: 5px;text-align: left;">{ORIGNAL_ITEM}</td>                      </tr>                         <tr>                        <th style="padding: 5px;text-align: left;">Item Class:</td>                        <td style="padding: 5px;text-align: left;">{ITEM_CLASS}</td>                         <th style="padding: 5px;text-align: left;">Parent Item: </td>                        <td style="padding: 5px;text-align: left;">{PARENT_ITEM}</td>                      </tr>                    <tr>                        <th style="padding: 5px;text-align: left;">Tech Para 1:</td>                        <td style="padding: 5px;text-align: left;">{TECH_PARA1}</td>                       <th style="padding: 5px;text-align: left;">Tech Para 3:</td>                        <td style="padding: 5px;text-align: left;">{TECH_PARA3}</td>                      </tr>                         <tr>                        <th style="padding:5px;text-align: left;">Tech Para 2:</th>                        <td style="padding: 5px;text-align: left;">{TECH_PARA2}</td>                          <th style="padding:5px;text-align: left;">Tech Para 4:</th>                        <td style="padding: 5px;text-align: left;">{TECH_PARA4}</td>                          </tr>                    </table>          <br/><br/>          </body>        </html>                '''        outputFilename = f"files/Item {ITEM_CODE} Details.pdf"        # Utility function        # open output file for writing (truncated binary)        resultFile = open(outputFilename, "w+b")        # convert HTML to PDF        pisaStatus = pisa.CreatePDF(            sourceHtml,  # the HTML to convert            dest=resultFile)  # file handle to recieve result        # close output file        resultFile.close()  # close output file        message = get_template('apex_soa1.html').render(ctx)        msg = EmailMessage(            f'Item {ITEM_CODE} awaiting approval for masters.',            message,            'harshitaagarwal219@gmail.com',  # will be change            # ['harshita.agarwal@cselectric.co.in ', 'puneet.kumar@cselectric.co.in'],            [EMAIL],        )        msg.content_subtype = "html"  # Main content is now text/html        msg.attach_file(f"files/Item {ITEM_CODE} Details.pdf")        msg.send()        x = datetime.datetime.now()        date = x.strftime("%Y-%m-%d")        time = x.strftime("%H:%M:%S")        cursor = connection.cursor()        data = f'''INSERT INTO public.app_apextable(                    trx_label, forwarded_to, forwarded_by, item_template, apex_id,                 mail_status,item_code, sys_date, sys_time, email, initiator_email)            VALUES ({trx_level}, {Forwarded_to}, {Forwarded_by}, '{ITEM_TEMPLATE}', {ID}, 'Sent','{ITEM_CODE}','{date}','{time}','{EMAIL}','{INITIATOR_EMAIL}');'''        cursor.execute(data)        message_response = f'Mail has been delivered  to {EMAIL}, Thank You!!'        return JsonResponse({'Message':message_response})    else:        return JsonResponse({'Message':'SID value should be PROD'})def approved_yes(request,id,id1, id2, id3, id4):    '''     approved Yes    :param request:    :param pk:    :return:    '''    try:        id=id        id1 =id1        id2 = id2        id3 = id3        id4 = id4        dsn_tns = cx_Oracle.makedsn('192.168.100.121', '1525', service_name='SANDBOX')        conn_ora = cx_Oracle.connect(user=r'APEX_EBS_EXTENSION', password='sbapex123', dsn=dsn_tns)        cursor = conn_ora.cursor()        # query=f"INSERT INTO {table_name}  (ID, STATUS) VALUES ({pk}, 'Y')"        query=f'''                declare                p_entity_trx_id number;                p_trx_level number;                p_forward_by number;                p_forward_to number;                p_approve_date date;                p_forward_note varchar2(300);                p_approve_note varchar2(300);                p_item_template varchar2(300);                l_err_status varchar2(300);                l_err_msg varchar2(300);                begin                XXAPX_103_APP_PKG.approval_transaction(p_entity_trx_id => '{id4}',                p_trx_level => '{id}',                p_forward_by => '{id1}',                p_forward_to => '{id2}',                p_approve_date => SYSDATE,                p_forward_note => 'na',                p_approve_note => NULL,                p_item_template =>'{id3}',                p_err_status => l_err_status,                p_err_msg => l_err_msg);                dbms_output.put_line(l_err_msg);                end;                '''        cursor.execute(query)        conn_ora.commit()        return JsonResponse({'Message': "The Item has been approved !!"})    except ObjectDoesNotExist:        raise Http404def reject_item(request, pk):    '''    Frequent Visitor Who approved Yes by HOST    :param request:    :param pk:    :return:    '''    try:        pk =pk        dsn_tns = cx_Oracle.makedsn('192.168.100.121', '1525', service_name='SANDBOX')        conn_ora = cx_Oracle.connect(user=r'APEX_EBS_EXTENSION', password='sbapex123', dsn=dsn_tns)        cursor = conn_ora.cursor()        query= f'''            declare            p_seq_id number;            p_forward_note varchar2(300);            begin            XXAPX_103_APP_PKG.reject_item(p_seq_id =>{pk},            p_forward_note =>'na');            end;        '''        cursor.execute(str(query))        conn_ora.commit()        return JsonResponse({'Message': "The Item has been rejected !!"})    except ObjectDoesNotExist:        raise Http404